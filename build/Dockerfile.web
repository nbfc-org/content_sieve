FROM node:16-bullseye-slim as webbuild

WORKDIR /build/web

COPY web/package*.json ./
RUN npm ci

WORKDIR /build

COPY web web
COPY lib lib

WORKDIR /build/web

ARG nodeenv
ENV POI_APP_NODE_ENV $nodeenv

ARG webgraphql
ENV POI_APP_WEB_GRAPHQL $webgraphql

RUN npm run build_prod

FROM nginx:alpine

WORKDIR /usr/share/nginx/html

ARG nodeenv

COPY --from=webbuild /build/web/dist .
COPY build/$nodeenv/router.conf /etc/nginx/conf.d/default.conf
