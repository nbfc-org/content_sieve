FROM node:14-bullseye-slim as webbuild

WORKDIR /build/web

COPY web/package*.json ./
RUN npm i

WORKDIR /build

COPY web web
COPY lib lib

WORKDIR /build/web

RUN npm i

ARG nodeenv

RUN npx vite build -m $nodeenv

FROM nginx:alpine

WORKDIR /usr/share/nginx/html

ARG nodeenv

ENV ESC='$'

COPY --from=webbuild /build/web/dist .
COPY build/$nodeenv/nginx.tmpl /etc/nginx/nginx.tmpl

CMD /bin/sh -c "envsubst < /etc/nginx/nginx.tmpl > /etc/nginx/conf.d/router.conf && nginx -g 'daemon off;' || cat /etc/nginx/conf.d/router.conf"
